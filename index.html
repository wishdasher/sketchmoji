<html>
<head>
  <meta charset='utf-8'>
  <title>SketchMoji</title>

  <link rel="stylesheet" type="text/css" href="styles.css">

  <script type="text/javascript">

  let mousePressed = false;
  let lastX, lastY;
  let ctx;
  let canvas;
  // point data to be sent
  let points = {
    x: [],
    y: [],
    t: []
  };

  let labelToEmoji = {
    "PARTY": "ðŸŽ‰",
    "FIRE": "ðŸ”¥",
    "SMILE": "ðŸ˜Š",
    "THUMBSUP": "ðŸ‘",
    "HEART": "ðŸ’™",
    "PRAY": "ðŸ™",
    "HEARTEYES": "ðŸ˜",
    "CRYING": "ðŸ˜­",
    "CHECKMARK": "âœ”ï¸",
    "SOCCERBALL": "âš½",
    "BREAD": "ðŸ¥–",
  }

  function init() {
    canvas = document.getElementById('sketchCanvas');
    ctx = canvas.getContext("2d");
    const bounds = canvas.getBoundingClientRect();

    canvas.addEventListener("mousedown", function (e) {
      mousePressed = true;
      draw(e.pageX - bounds.left, e.pageY - bounds.top, false);
    });

    canvas.addEventListener("mousemove", function (e) {
      if (mousePressed) {
        draw(e.pageX - bounds.left, e.pageY - bounds.top, true);
      }
    });

    canvas.addEventListener("mouseup", function (e) {
      mousePressed = false;
      sendToClassify(points);
    });

    canvas.addEventListener("mouseleave", function (e) {
      mousePressed = false;
    });
  }

  function draw(x, y, isDown) {
      if (isDown) {
        ctx.beginPath();
        // ctx.strokeStyle = ('#selColor').val();
        // ctx.lineWidth = ('#selWidth').val();
        ctx.lineJoin = "round";
        ctx.moveTo(lastX, lastY);
        ctx.lineTo(x, y);
        ctx.closePath();
        ctx.stroke();
      }
      const time = Date.now();
      points.x.push(x);
      points.y.push(y);
      points.t.push(time);
      console.log(time + ": " + x + ", " + y);
      lastX = x;
      lastY = y;
  }

  function clearCanvas() {
    // Use the identity matrix while clearing the canvas
    ctx.setTransform(1, 0, 0, 1, 0, 0);
    ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
    points.x.length = 0;
    points.y.length = 0;
    points.t.length = 0;
    console.log("Cleared");
  }

  function copyContents(i) {
      let emoji = document.getElementById("emoji-"+i);
      console.log(emoji.innerHTML + "ih")
      var textArea = document.createElement("textarea");
      textArea.style.position = 'fixed';
      textArea.style.top = 0;
      textArea.style.left = 0;
      textArea.style.display= "none";

      // // Ensure it has a small width and height. Setting to 1px / 1em
      // // doesn't work as this gives a negative w/h on some browsers.
      // textArea.style.width = '2em';
      // textArea.style.height = '2em';

      // // We don't need padding, reducing the size if it does flash render.
      // textArea.style.padding = 0;

      // // Clean up any borders.
      // textArea.style.border = 'none';
      // textArea.style.outline = 'none';
      // textArea.style.boxShadow = 'none';

      // // Avoid flash of white box if rendered for any reason.
      // textArea.style.background = 'transparent';

      textArea.value = emoji.innerHTML;
      document.body.appendChild(textArea);
      textArea.focus();
      textArea.select();
      // textArea.setSelectionRange(0, 99999); /*For mobile devices*/

      try {
        // Now that we've selected the anchor text, execute the copy command
          var successful = document.execCommand('copy');
          var msg = successful ? 'successful' : 'unsuccessful';
          console.log('Copy emoji command was ' + msg);
        } catch(err) {
          console.log('Oops, unable to copy');
        }

      // document.execCommand("copy");
  }

  function sendToClassify(inputData) {
    fetch('http://127.0.0.1:5000/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(inputData)
    })
      .then(response => {
        if (!response.ok) {
          throw new Error('Network response was not ok')
        }
        return response.json()
      })
      .then(result => {
        console.log("api returned",result)
        result['best'].map((label,index) => {document.getElementById("emoji-"+(1+index)).innerHTML = labelToEmoji[label]})
    })}

  </script>

</head>


<body onload="init();">
  <h1>SketchMoji</h1>

  <div id="app-area">
    <canvas id="sketchCanvas" width="500" height="498"></canvas>
    <div id="suggestion-area">
      <div class="emoji-suggestion" onclick="copyContents(1)" id="emoji-1"></div>
      <div class="emoji-suggestion" onclick="copyContents(2)" id="emoji-2"></div>
      <div class="emoji-suggestion" onclick="copyContents(3)" id="emoji-3"></div>
      <div class="emoji-suggestion" onclick="copyContents(4)" id="emoji-4"></div>
      <div class="emoji-suggestion" onclick="copyContents(5)" id="emoji-5"></div>
    </div>
  </div>
  <button onclick="javascript:clearCanvas(); return false;">Clear</button>

</body>

</html>
